<div class="container mt-5">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0" style="font-weight: 700; color: #1e3a8a;"><i class="fas fa-building me-2 text-info"></i>My Properties</h2>
    <button *ngIf="user?.role === 'Owner' || (user?.roles && user.roles.includes('Owner'))" class="btn btn-primary btn-lg fw-bold" (click)="goToAddProperty()" style="box-shadow: 0 4px 12px rgba(30,58,138,0.10);">
      <i class="fas fa-plus me-1"></i> Add Property
    </button>
  </div>
  <div *ngIf="successMessage" class="custom-alert custom-alert-success animate__animated animate__fadeInDown">
    <span class="custom-alert-icon"><i class="fas fa-check-circle"></i></span>
    <span class="custom-alert-text">{{ successMessage }}</span>
    <span class="custom-alert-close" (click)="successMessage = ''">&times;</span>
  </div>
  <div *ngIf="errorMessage" class="custom-alert custom-alert-danger animate__animated animate__fadeInDown">
    <span class="custom-alert-icon"><i class="fas fa-exclamation-circle"></i></span>
    <span class="custom-alert-text">{{ errorMessage }}</span>
    <span class="custom-alert-close" (click)="errorMessage = ''">&times;</span>
  </div>
  <div *ngIf="myProperties.length === 0" class="alert alert-info text-center py-4" style="font-size: 1.2rem;">
    You have no properties yet. Click <b>Add Property</b> to create your first listing!
  </div>
  <div *ngIf="pendingDeleteId !== null" class="modal-overlay">
    <div class="custom-modal animate__animated animate__zoomIn">
      <div class="modal-icon"><i class="fas fa-exclamation-triangle"></i></div>
      <div class="modal-title">Delete Property</div>
      <div class="modal-message">Are you sure you want to delete this property? This action cannot be undone.</div>
      <div class="modal-actions">
        <button class="btn btn-danger" (click)="confirmDelete()"><i class="fas fa-trash me-1"></i> Delete</button>
        <button class="btn btn-secondary ms-2" (click)="cancelDelete()">Cancel</button>
      </div>
    </div>
  </div>
  <div *ngIf="myProperties.length === 0" class="alert alert-info text-center py-4" style="font-size: 1.2rem;">
    You have no properties yet. Click <b>Add Property</b> to create your first listing!
  </div>
  <div class="row g-4">
    <div class="col-md-6 col-lg-4" *ngFor="let property of myProperties">
      <div class="card shadow property-card border-0 rounded-4 h-100 position-relative">
        <!-- شارة حالة العقار -->
        <span class="property-status-badge position-absolute top-0 end-0 m-3" [ngClass]="{
          'available': property.status === 'Available',
          'pending': property.status === 'Pending',
          'sold': property.status === 'Sold'
        }">
          <i class="fas fa-info-circle me-1"></i> {{ property.status }}
        </span>
        <!-- سلايدر صور العقار -->
        <div *ngIf="property.imagePaths && property.imagePaths.length" class="property-carousel-wrapper">
          <div id="property-carousel-{{property.id}}" class="carousel slide property-carousel" data-bs-ride="carousel">
            <div class="carousel-inner">
              <div *ngFor="let img of property.imagePaths; let i = index" class="carousel-item" [class.active]="i === 0">
                <img [src]="getImageUrl(img)" class="d-block w-100 property-carousel-img" alt="Property Image">
                <div class="carousel-img-index">{{ i + 1 }} / {{ property.imagePaths.length }}</div>
              </div>
            </div>
            <button class="carousel-control-prev" type="button" [attr.data-bs-target]="'#property-carousel-' + property.id" data-bs-slide="prev">
              <span class="carousel-control-prev-icon" aria-hidden="true"></span>
              <span class="visually-hidden">Previous</span>
            </button>
            <button class="carousel-control-next" type="button" [attr.data-bs-target]="'#property-carousel-' + property.id" data-bs-slide="next">
              <span class="carousel-control-next-icon" aria-hidden="true"></span>
              <span class="visually-hidden">Next</span>
            </button>
          </div>
        </div>
        <div class="card-body py-3">
          <h5 class="card-title mb-3 property-title">
            <i class="fas fa-home me-2 text-primary"></i>{{ property.title }}
          </h5>
          <div class="property-detail-row mb-2">
            <i class="fas fa-map-marker-alt me-1 text-danger"></i>
            <span><strong>City:</strong> {{ property.city }}</span>
            <span class="mx-2">|</span>
            <span><strong>Region:</strong> {{ property.region }}</span>
          </div>
          <div class="property-detail-row mb-2">
            <i class="fas fa-door-open me-1 text-secondary"></i>
            <span><strong>Rooms:</strong> {{ property.roomsCount }}</span>
          </div>
          <div class="property-detail-row mb-2">
            <i class="fas fa-money-bill-wave me-1 text-success"></i>
            <span><strong>Price:</strong> {{ property.price | currency:'USD':'symbol':'1.0-0' }}</span>
          </div>
        </div>
        <!-- شريط الأزرار السفلي -->
        <div class="property-btn-bar d-flex justify-content-between align-items-center px-3 pb-3 gap-2">
          <button class="btn btn-warning property-btn" (click)="startEditProperty(property)">
            <i class="fas fa-edit me-1"></i> <span class="d-none d-sm-inline">Edit</span>
          </button>
          <button class="btn btn-info text-white property-btn" (click)="startEditImages(property)">
            <i class="fas fa-images me-1"></i> <span class="d-none d-sm-inline">Edit Images</span>
          </button>
          <button class="btn btn-danger property-btn" (click)="deleteProperty(property.id)">
            <i class="fas fa-trash me-1"></i> <span class="d-none d-sm-inline">Delete</span>
          </button>
          <button *ngIf="property.status !== 'Available'" class="btn btn-primary property-btn" (click)="openAdvertiseModal(property)">
            <i class="fas fa-bullhorn me-1"></i> <span class="d-none d-sm-inline">Advertise</span>
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Edit Images Modal -->
  <div *ngIf="editingImagesProperty" class="modal-overlay">
    <div class="custom-modal animate__animated animate__zoomIn" style="max-width: 600px;">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-images me-2 text-primary"></i>
          Edit Images - {{ editingImagesProperty.title }}
        </h5>
        <button type="button" class="btn-close" (click)="cancelEditImages()"></button>
      </div>
      <div class="modal-body">
        <!-- Current Images -->
        <div class="mb-4">
          <h6><i class="fas fa-photo-video me-1"></i> Current Images</h6>
          <div class="row g-2">
            <div class="col-md-4 col-6" *ngFor="let image of editingImagesProperty.images; let i = index">
              <div class="position-relative">
                <img [src]="getImageUrl(image.imagePath)" class="img-fluid rounded" style="width: 100%; height: 120px; object-fit: cover;" alt="Property Image">
                <button class="btn btn-danger btn-sm position-absolute top-0 end-0 m-1"
                        (click)="openDeleteImageModal(i)"
                        [disabled]="deletingImageIndex === i"
                        style="width: 25px; height: 25px; padding: 0; border-radius: 50%;">
                  <i *ngIf="deletingImageIndex !== i" class="fas fa-times"></i>
                  <i *ngIf="deletingImageIndex === i" class="fas fa-spinner fa-spin"></i>
                </button>
              </div>
            </div>
            <div class="col-12" *ngIf="!editingImagesProperty.images || editingImagesProperty.images.length === 0">
              <div class="text-center text-muted py-3">
                <i class="fas fa-image fa-2x mb-2"></i>
                <p>No images uploaded yet</p>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Add New Images -->
        <div class="mb-3">
          <h6><i class="fas fa-plus me-1"></i> Add New Images</h6>
          <input type="file" 
                 class="form-control" 
                 (change)="onNewImagesSelected($event)" 
                 multiple 
                 accept="image/*"
                 [disabled]="uploadingImages">
          <small class="text-muted">You can select multiple images. Supported formats: JPG, PNG, GIF</small>
        </div>
        
        <!-- Preview New Images -->
        <div *ngIf="newImages.length > 0" class="mb-3">
          <h6><i class="fas fa-eye me-1"></i> Preview New Images</h6>
          <div class="row g-2">
            <div class="col-md-4 col-6" *ngFor="let image of newImages; let i = index">
              <div class="position-relative">
                <img [src]="image.preview" class="img-fluid rounded" style="width: 100%; height: 120px; object-fit: cover;" alt="Preview">
                <button class="btn btn-danger btn-sm position-absolute top-0 end-0 m-1" 
                        (click)="removeNewImage(i)" 
                        style="width: 25px; height: 25px; padding: 0; border-radius: 50%;">
                  <i class="fas fa-times"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Loading State -->
        <div *ngIf="uploadingImages" class="text-center py-3">
          <i class="fas fa-spinner fa-spin fa-2x text-primary"></i>
          <p class="mt-2">Uploading images...</p>
        </div>
        
        <!-- Success/Error Messages -->
        <div *ngIf="imagesSuccessMessage" class="alert alert-success animate__animated animate__fadeInDown">
          <i class="fas fa-check-circle me-1"></i> {{ imagesSuccessMessage }}
        </div>
        <div *ngIf="imagesErrorMessage" class="alert alert-danger animate__animated animate__fadeInDown">
          <i class="fas fa-exclamation-circle me-1"></i> {{ imagesErrorMessage }}
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="cancelEditImages()" [disabled]="uploadingImages">
          Cancel
        </button>
        <button type="button" class="btn btn-primary" (click)="saveImages()" [disabled]="uploadingImages || newImages.length === 0">
          <span *ngIf="!uploadingImages"><i class="fas fa-save me-1"></i> Save Images</span>
          <span *ngIf="uploadingImages"><i class="fas fa-spinner fa-spin me-1"></i> Saving...</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Modal تأكيد حذف الصورة -->
  <div *ngIf="showDeleteImageModal" class="modal-overlay">
    <div class="custom-modal animate__animated animate__zoomIn" style="max-width: 400px;">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-exclamation-triangle text-danger me-2"></i>Confirm Delete</h5>
        <button type="button" class="btn-close" (click)="closeDeleteImageModal()"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete this image? This action cannot be undone.</p>
        <div class="text-center my-2">
          <img *ngIf="editingImagesProperty.images && imageToDeleteIndex !== null && editingImagesProperty.images[imageToDeleteIndex]" [src]="getImageUrl(editingImagesProperty.images[imageToDeleteIndex].imagePath)" style="max-width: 180px; max-height: 120px; border-radius: 8px; box-shadow: 0 2px 8px rgba(220,53,69,0.12);">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="closeDeleteImageModal()">Cancel</button>
        <button class="btn btn-danger" (click)="confirmDeleteImage()" [disabled]="deletingImageIndex === imageToDeleteIndex">
          <span *ngIf="deletingImageIndex !== imageToDeleteIndex"><i class="fas fa-trash me-1"></i>Delete</span>
          <span *ngIf="deletingImageIndex === imageToDeleteIndex"><i class="fas fa-spinner fa-spin me-1"></i>Deleting...</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Modal تعديل العقار -->
  <div *ngIf="editProperty" class="modal-overlay">
    <div class="custom-modal animate__animated animate__zoomIn" style="max-width: 500px;">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-edit text-primary me-2"></i>Edit Property</h5>
        <button type="button" class="btn-close" (click)="editProperty = null"></button>
      </div>
      <div class="modal-body">
        <form [formGroup]="editPropertyForm" (ngSubmit)="saveEditProperty()">
          <input formControlName="title" class="form-control mb-2" placeholder="Title">
          <input formControlName="price" type="number" class="form-control mb-2" placeholder="Price">
          <input formControlName="city" class="form-control mb-2" placeholder="City">
          <input formControlName="region" class="form-control mb-2" placeholder="Region">
          <input formControlName="description" class="form-control mb-2" placeholder="Description">
          <input formControlName="roomsCount" type="number" class="form-control mb-2" placeholder="Rooms Count">
          <select formControlName="genderPreference" class="form-control mb-2">
            <option value="">Gender Preference</option>
            <option value="Male">Male</option>
            <option value="Female">Female</option>
          </select>
          <input formControlName="street" class="form-control mb-2" placeholder="Street">
          <select formControlName="status" class="form-control mb-2">
            <option value="">Status</option>
            <option value="Available">Available</option>
            <option value="Pending">Pending</option>
          </select>
          <div class="d-flex gap-2 mt-3 justify-content-end">
            <button type="button" class="btn btn-secondary px-4" (click)="editProperty = null">Cancel</button>
            <button type="submit" class="btn btn-success px-4" [disabled]="editPropertyForm.invalid">Save</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal دفع الإعلان -->
  <div *ngIf="advertiseModalProperty" class="modal-overlay">
    <div class="custom-modal animate__animated animate__zoomIn" style="max-width: 500px;">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-bullhorn text-primary me-2"></i>Advertise Property</h5>
        <button type="button" class="btn-close" (click)="closeAdvertiseModal()"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <strong>Title:</strong> {{ advertiseModalProperty.title }}<br>
          <strong>City:</strong> {{ advertiseModalProperty.city }}<br>
          <strong>Region:</strong> {{ advertiseModalProperty.region }}<br>
          <strong>Price:</strong> {{ advertiseModalProperty.price | currency:'USD':'symbol':'1.0-0' }}<br>
        </div>
        <div class="mb-3">
          <strong>Advertise Fee:</strong> <span class="text-success">{{ advertiseFee | currency:'USD':'symbol':'1.0-0' }}</span>
        </div>
        <div *ngIf="!advertiseIframeUrl">
          <button class="btn btn-success w-100" (click)="initiateAdvertisePayment()" [disabled]="advertiseLoading">
            <span *ngIf="!advertiseLoading"><i class="fas fa-credit-card me-1"></i> ادفع الآن</span>
            <span *ngIf="advertiseLoading"><i class="fas fa-spinner fa-spin me-1"></i> جاري تجهيز الدفع...</span>
          </button>
        </div>
        <div *ngIf="advertiseIframeUrl" class="mt-3">
          <iframe [src]="advertiseIframeUrl" width="100%" height="420" style="border: none; border-radius: 10px;"></iframe>
          <div class="text-center mt-2">
            <div class="alert alert-info mb-2">بعد إتمام الدفع سيتم تحويلك تلقائيًا لتأكيد العملية.</div>
            <button class="btn btn-outline-secondary btn-sm w-100" (click)="closeAdvertiseModal()">إغلاق</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal تأكيد الدفع بعد Paymob -->
  <div *ngIf="showAdvertiseConfirmModal" class="modal-overlay">
    <div class="custom-modal animate__animated animate__zoomIn" style="max-width: 400px;">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-check-circle text-success me-2"></i>Confirm Payment</h5>
        <button type="button" class="btn-close" (click)="closeAdvertiseConfirmModal()"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">Transaction ID from Paymob</label>
          <input type="text" class="form-control" [(ngModel)]="advertiseTransactionId" placeholder="Enter transactionId from Paymob">
        </div>
        <button class="btn btn-success w-100" (click)="confirmAdvertisePayment(advertiseTransactionId)" [disabled]="advertiseConfirmLoading || !advertiseTransactionId">
          <span *ngIf="!advertiseConfirmLoading"><i class="fas fa-check me-1"></i> Confirm Payment</span>
          <span *ngIf="advertiseConfirmLoading"><i class="fas fa-spinner fa-spin me-1"></i> Confirming...</span>
        </button>
        <div *ngIf="advertiseConfirmSuccess" class="alert alert-success mt-3 animate__animated animate__fadeInDown">
          <i class="fas fa-check-circle me-1"></i> Payment confirmed! Your property is now advertised.
        </div>
        <div *ngIf="advertiseConfirmError" class="alert alert-danger mt-3 animate__animated animate__fadeInDown">
          <i class="fas fa-exclamation-circle me-1"></i> {{ advertiseConfirmError }}
        </div>
      </div>
    </div>
  </div>

  <!-- Toast للنجاح أو الخطأ -->
  <div *ngIf="toastMessage" class="custom-alert animate__animated animate__fadeInDown" [ngClass]="toastType === 'success' ? 'custom-alert-success' : 'custom-alert-danger'" style="position: fixed; top: 32px; right: 32px; z-index: 2000; min-width: 220px;">
    <span class="custom-alert-icon"><i [ngClass]="toastType === 'success' ? 'fas fa-check-circle' : 'fas fa-exclamation-circle'"></i></span>
    <span class="custom-alert-text">{{ toastMessage }}</span>
    <span class="custom-alert-close" (click)="toastMessage = ''">&times;</span>
  </div>
</div>
